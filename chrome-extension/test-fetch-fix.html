<!DOCTYPE html>
<html>
<head>
    <title>Fetch Fix Test</title>
</head>
<body>
    <h1>Testing Fetch Fix</h1>
    <div id="status">Testing...</div>
    
    <script src="config.js"></script>
    <script src="logger.js"></script>
    <script src="security.js"></script>
    <script src="api.js"></script>
    
    <script>
        async function testFetch() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.innerHTML = "Creating API client...";
                const apiClient = new ApiClient();
                
                statusDiv.innerHTML = "Testing basic fetch functionality...";
                console.log('Starting basic fetch test...');
                
                const fetchResult = await apiClient.testFetch();
                
                if (fetchResult.success) {
                    statusDiv.innerHTML = `✅ Fetch Fix Success! ${fetchResult.message}`;
                    console.log('Basic fetch test passed:', fetchResult);
                    
                    // Now try the health check
                    statusDiv.innerHTML += "<br>Testing health check...";
                    try {
                        const healthResult = await apiClient.checkHealth();
                        statusDiv.innerHTML += `<br>✅ Health check also passed: ${JSON.stringify(healthResult)}`;
                    } catch (healthError) {
                        statusDiv.innerHTML += `<br>⚠️ Health check failed (server may be down): ${healthError.message}`;
                    }
                } else {
                    statusDiv.innerHTML = `❌ FAILED: ${fetchResult.message} - ${fetchResult.error}`;
                }
                
            } catch (error) {
                console.error('Test failed:', error);
                
                if (error.message.includes('Illegal invocation')) {
                    statusDiv.innerHTML = `❌ FAILED: Illegal invocation error still present: ${error.message}`;
                } else if (error.message.includes('fetch')) {
                    statusDiv.innerHTML = `❌ FAILED: Fetch error: ${error.message}`;
                } else {
                    statusDiv.innerHTML = `⚠️ Different error: ${error.message}`;
                }
            }
        }
        
        // Test when page loads
        document.addEventListener('DOMContentLoaded', testFetch);
    </script>
</body>
</html>